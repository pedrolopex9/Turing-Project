<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Arena de Otimiza√ß√£o v2.2 (Combinada)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilo Dark Mode Profissional */
        body { background-color: #1e1e1e; color: #d4d4d4; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        .layout { display: grid; grid-template-columns: 320px 1fr; gap: 20px; height: 95vh; }
        .sidebar { background: #252526; padding: 20px; border-radius: 8px; border: 1px solid #3e3e42; }
        .main { background: #252526; padding: 20px; border-radius: 8px; border: 1px solid #3e3e42; display: flex; flex-direction: column; }
        
        h2 { color: #007acc; border-bottom: 1px solid #3e3e42; padding-bottom: 10px; margin-top: 0; }
        label { display: block; margin-top: 15px; font-size: 0.9em; color: #cccccc; }
        input, select { width: 100%; padding: 8px; margin-top: 5px; background: #3c3c3c; border: 1px solid #3e3e42; color: white; border-radius: 4px; }
        
        button { width: 100%; padding: 15px; margin-top: 25px; font-weight: bold; cursor: pointer; border: none; border-radius: 4px; transition: 0.3s; }
        .btn-start { background-color: #0e639c; color: white; }
        .btn-start:hover { background-color: #1177bb; }
        
        #logs { height: 150px; overflow-y: auto; font-family: monospace; font-size: 12px; background: #1e1e1e; border: 1px solid #3e3e42; margin-top: 20px; padding: 10px; color: #4caf50; }
        
        .stats-row { display: flex; gap: 20px; margin-bottom: 10px; justify-content: space-around; background: #1e1e1e; padding: 10px; border-radius: 4px; }
        .stat-card { text-align: center; }
        .stat-val { font-size: 1.5em; font-weight: bold; }
        .pso-color { color: #ff6b6b; }
        .ga-color { color: #4facfe; }
        .simplex-color { color: #50fa7b; } 
        .combined-color { color: #ffeb3b; } /* ‚≠êÔ∏è Cor para o resultado combinado */
        .hidden { display: none !important; } /* Classe para esconder */
    </style>
</head>
<body>

<div class="layout">
    <div class="sidebar">
        <h2>üîß Configura√ß√£o</h2>
        
        <label>Arquivo Execut√°vel (.exe)</label>
        <input type="text" id="exePath" value="modelo10.exe">
        
        <label>Estrat√©gia de Busca</label>
        <select id="method" onchange="toggleStatCards()"> 
            <option value="pso">üöÄ Apenas PSO (Enxame)</option>
            <option value="ga">üß¨ Apenas Gen√©tico (Evolu√ß√£o)</option>
            <option value="simplex">üî∫ Apenas Simplex (Nelder-Mead)</option>
            <option value="battle">‚öîÔ∏è BATALHA (PSO vs GA vs Simplex)</option>
            <option value="combined">üéØ COMBINADA (PSO -> Simplex / Itera√ß√£o)</option> 
        </select>
        
        <label>Objetivo</label>
        <select id="goal">
            <option value="min">üìâ Minimizar (Buscar Vale)</option>
            <option value="max">üìà Maximizar (Buscar Pico)</option>
        </select>

        <button class="btn-start" onclick="startSimulation()">INICIAR PROCESSO</button>

        <div id="logs">Logs do sistema...</div>
    </div>

    <div class="main">
        <div class="stats-row">
            <div class="stat-card">
                <div>Itera√ß√£o</div>
                <div class="stat-val" id="iterDisplay">0</div>
            </div>
            
            <div class="stat-card pso-color" id="psoCard">
                <div>Melhor PSO</div>
                <div class="stat-val" id="psoDisplay">---</div>
            </div>
            <div class="stat-card ga-color" id="gaCard">
                <div>Melhor GA</div>
                <div class="stat-val" id="gaDisplay">---</div>
            </div>
             <div class="stat-card simplex-color" id="simplexCard"> 
                <div>Melhor Simplex</div>
                <div class="stat-val" id="simplexDisplay">---</div>
            </div>

            <div class="stat-card combined-color hidden" id="combinedCard">
                <div>Melhor COMBINADO</div>
                <div class="stat-val" id="combinedDisplay">---</div>
            </div>
        </div>
        
        <div style="flex-grow: 1; position: relative;">
            <canvas id="optChart"></canvas>
        </div>
    </div>
</div>

<script>
    let chart;

    function toggleStatCards() {
        const method = document.getElementById('method').value;
        const isCombined = method === 'combined';

        // 1. Visibilidade dos Cart√µes
        document.getElementById('psoCard').classList.toggle('hidden', isCombined);
        document.getElementById('gaCard').classList.toggle('hidden', isCombined);
        document.getElementById('simplexCard').classList.toggle('hidden', isCombined);
        document.getElementById('combinedCard').classList.toggle('hidden', !isCombined);

        // 2. Apar√™ncia do Gr√°fico
        if (chart && chart.data && chart.data.datasets.length >= 3) {
            
            chart.data.datasets[0].label = 'Melhor PSO (Enxame)';
            chart.data.datasets[0].borderColor = '#ff6b6b'; 
            
            if (isCombined) {
                // Modo COMBINADA: Dataset 0 assume o papel da Combinada e esconde os outros
                chart.data.datasets[0].label = 'Resultado Combinado (PSO->Simplex)';
                chart.data.datasets[0].borderColor = '#ffeb3b'; // Usa a cor combinada
                
                chart.data.datasets[1].hidden = true; // Esconde GA
                chart.data.datasets[2].hidden = true; // Esconde Simplex
            } else {
                // Outros Modos: Todos os datasets voltam a ser vis√≠veis
                chart.data.datasets[1].hidden = false;
                chart.data.datasets[2].hidden = false;
            }
            chart.update();
        }
    }

    window.onload = function() {
        const ctx = document.getElementById('optChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    // Dataset 0: PSO / COMBINADO
                    {
                        label: 'Melhor PSO (Enxame)',
                        borderColor: '#ff6b6b', 
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        data: [],
                        borderWidth: 2,
                        tension: 0.3
                    },
                    // Dataset 1: GA
                    {
                        label: 'Melhor Gen√©tico (Evolu√ß√£o)',
                        borderColor: '#4facfe', 
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        data: [],
                        borderWidth: 2,
                        tension: 0.3
                    },
                    // Dataset 2: SIMPLEX
                    {
                        label: 'Melhor Simplex (Nelder-Mead)',
                        borderColor: '#50fa7b', 
                        backgroundColor: 'rgba(80, 250, 123, 0.1)',
                        data: [],
                        borderWidth: 2,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                scales: { x: { grid: { display: false } }, y: { grid: { color: '#3e3e42' } } }
            }
        });
        toggleStatCards();
    };

    async function startSimulation() {
        const method = document.getElementById('method').value;
        const exe = document.getElementById('exePath').value;
        const goal = document.getElementById('goal').value;
        const logDiv = document.getElementById('logs');
        
        toggleStatCards(); 

        // Resetar Visual
        chart.data.labels = [];
        chart.data.datasets[0].data = [];
        chart.data.datasets[1].data = [];
        chart.data.datasets[2].data = []; 
        
        document.getElementById('psoDisplay').innerText = '---';
        document.getElementById('gaDisplay').innerText = '---';
        document.getElementById('simplexDisplay').innerText = '---';
        document.getElementById('combinedDisplay').innerText = '---'; // Reset do combinado

        chart.update();
        logDiv.innerHTML = "Iniciando conex√£o com o n√∫cleo...<br>";

        try {
            const response = await fetch(`/run?exe=${encodeURIComponent(exe)}&method=${method}&goal=${goal}`);
            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (!line.trim()) continue;
                    
                    if (line.startsWith("DEBUG:")) {
                        logDiv.innerHTML += `<span style="color:yellow">${line}</span><br>`;
                        logDiv.scrollTop = logDiv.scrollHeight;
                    } 
                    else if (line.startsWith("{")) {
                        try {
                            const data = JSON.parse(line);
                            updateChart(data, method);
                        } catch(e) { console.log("Erro JSON", e); }
                    }
                }
            }
            logDiv.innerHTML += "<span style='color:#00ff00'>>>> CONCLUS√ÉO DO PROCESSO.</span><br>";
        } catch (err) {
            logDiv.innerHTML += `<span style="color:red">ERRO CR√çTICO: ${err}</span><br>`;
        }
    }

    function updateChart(data, method) {
        document.getElementById('iterDisplay').innerText = data.iteracao;
        chart.data.labels.push(data.iteracao);

        const isCombined = method === 'combined';
        let combinedValue = null;

        // Atualiza Dataset 0 (PSO / OU COMBINADO)
        if (data.pso_best !== undefined) {
            chart.data.datasets[0].data.push(data.pso_best);
            combinedValue = data.pso_best; // Em COMBINED, PSO_best √© o valor final

            // ‚≠êÔ∏è S√ì ATUALIZA O DISPLAY INDIVIDUAL SE N√ÉO FOR O MODO COMBINADA
            if (!isCombined) {
                document.getElementById('psoDisplay').innerText = data.pso_best !== null ? data.pso_best.toFixed(4) : '---';
            }
        } else {
            chart.data.datasets[0].data.push(null); 
        }

        // Atualiza Dataset 1 (GA)
        if (data.ga_best !== undefined && data.ga_best !== null) {
            chart.data.datasets[1].data.push(data.ga_best);
            // ‚≠êÔ∏è S√ì ATUALIZA O DISPLAY INDIVIDUAL SE N√ÉO FOR O MODO COMBINADA
            if (!isCombined) {
                document.getElementById('gaDisplay').innerText = data.ga_best.toFixed(4);
            } else {
                 document.getElementById('gaDisplay').innerText = '---'; // Limpa se for combinado
            }
        } else {
            chart.data.datasets[1].data.push(null);
            if (!isCombined) document.getElementById('gaDisplay').innerText = '---'; 
        }

        // Atualiza Dataset 2 (Simplex)
        if (data.simplex_best !== undefined) {
            chart.data.datasets[2].data.push(data.simplex_best); 
            // ‚≠êÔ∏è S√ì ATUALIZA O DISPLAY INDIVIDUAL SE N√ÉO FOR O MODO COMBINADA
            if (!isCombined) {
                document.getElementById('simplexDisplay').innerText = data.simplex_best !== null ? data.simplex_best.toFixed(4) : '---';
            } else {
                document.getElementById('simplexDisplay').innerText = '---'; // Limpa se for combinado
            }
        } else {
            chart.data.datasets[2].data.push(null);
        }

        // ‚≠êÔ∏è ATUALIZA√á√ÉO PRINCIPAL: Resultado Combinado (Sempre que houver valor)
        if (isCombined && combinedValue !== null) {
             document.getElementById('combinedDisplay').innerText = combinedValue.toFixed(4);
             // Limpa o display individual do PSO se for modo combinado, caso ele tenha sido atualizado acima
             document.getElementById('psoDisplay').innerText = '---'; 
        } else if (isCombined) {
            document.getElementById('combinedDisplay').innerText = '---';
        }

        chart.update();
    }
</script>
</body>
</html>
